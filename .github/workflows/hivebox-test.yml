name: HiveBox CI
on:
    push:
      tags:
        - 'v*'
      branches:
        - 'release/v*'  
jobs:

    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Setup go
              uses: actions/checkout@v4
            - uses: actions/setup-go@v5
              with:
                go-version: '1.22'

            - name: golangci-lint
              uses: golangci/golangci-lint-action@v6
              with:
                version: latest    

            - name: Lint Dockerfile
              uses: actions/checkout@v4
            - uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: Dockerfile

    build:
        runs-on: ubuntu-latest
        needs: lint
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Extract version from tag/branch
            run: echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV  

          - name: Build Docker Image
            run: docker build -f Dockerfile -t hivebox:${{ env.VERSION }} .
            
    test:
      runs-on: ubuntu-latest
      needs: build
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Run unit tests
          run: go test ./... -v

        - name: Print VERSION for testing
          run: echo "VERSION is ${{ env.VERSION }}"

        - name: Test /version endpoint
          run: |
            docker run -d -p 8080:8080 hivebox:${{ env.VERSION }}
            sleep 5
            curl http://localhost:8080/version

        - name: Clean up Docker images
          run: docker rmi hivebox:${{ env.VERSION }}